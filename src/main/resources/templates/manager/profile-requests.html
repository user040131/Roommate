<!--
  파일(권장): src/main/resources/templates/manager/profile-requests.html

  컨트롤러 예시(모델 주입):
  @Controller
  @RequestMapping("/manager/profile")
  public class ProfileRequestReviewController {
      @GetMapping("/requests")
      public String list(Model model) {
          // 주소 변경 요청 목록
          // model.addAttribute("addressRequests", List<AddressChangeRequestView>);
          // 이메일 변경 요청 목록 (비번은 서버에서 직접 처리/재설정 링크 권장)
          // model.addAttribute("emailRequests", List<EmailChangeRequestView>);
          return "manager/profile-requests";
      }

      // 주소 승인: 요청 id 기준으로 학생 주소 갱신
      @PostMapping("/address-requests/{id}/approve")
      public String approveAddress(@PathVariable Long id,
                                   @RequestParam String postalCode,
                                   @RequestParam String address1,
                                   @RequestParam(required=false) String address2,
                                   RedirectAttributes ra) {
          // TODO: id 검증 → 값 적용 → 요청 상태 'APPROVED'
          ra.addFlashAttribute("msg","주소 변경을 적용했습니다.");
          return "redirect:/manager/profile/requests";
      }

      // 주소 반려
      @PostMapping("/address-requests/{id}/reject")
      public String rejectAddress(@PathVariable Long id,
                                  @RequestParam String reason,
                                  RedirectAttributes ra) {
          // TODO: 요청 상태 'REJECTED', 사유 저장/알림
          ra.addFlashAttribute("msg","주소 변경 요청을 반려했습니다.");
          return "redirect:/manager/profile/requests";
      }

      // 이메일 승인
      @PostMapping("/email-requests/{id}/approve")
      public String approveEmail(@PathVariable Long id,
                                 @RequestParam String newEmail,
                                 RedirectAttributes ra) {
          // TODO: 이메일 중복 검사 → 변경 → 요청 상태 'APPROVED'
          ra.addFlashAttribute("msg","이메일 변경을 적용했습니다.");
          return "redirect:/manager/profile/requests";
      }

      // 이메일 반려
      @PostMapping("/email-requests/{id}/reject")
      public String rejectEmail(@PathVariable Long id,
                                @RequestParam String reason,
                                RedirectAttributes ra) {
          // TODO: 요청 상태 'REJECTED', 사유 저장/알림
          ra.addFlashAttribute("msg","이메일 변경 요청을 반려했습니다.");
          return "redirect:/manager/profile/requests";
      }
  }

  뷰 DTO 예시(템플릿에서 참조하는 필드명):
  // AddressChangeRequestView: id, studentName, studentEmail, currentPostalCode, currentAddress1, currentAddress2,
  //                           reqPostalCode, reqAddress1, reqAddress2, submittedAt
  // EmailChangeRequestView:   id, studentName, studentEmail, currentEmail, newEmail, submittedAt
-->

<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>개인정보 변경 요청 검토 (매니저)</title>
    <style>
        :root{--sky1:#eaf6ff;--sky2:#d7efff;--card:#ffffffee;--muted:#5b6b7a;--bord:#d0d7e2;
            --btn:#1976d2;--btn2:#0ea5e9;--danger:#dc2626;--ok:#166534}
        *{box-sizing:border-box}
        body{margin:0;min-height:100vh;display:grid;place-items:start center;background:linear-gradient(180deg,var(--sky1),var(--sky2));font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px 12px}
        .container{width:min(1100px,96vw);display:grid;gap:16px}
        .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px}
        h1{margin:0 0 6px} h2{margin:0 0 8px}
        .hint{color:var(--muted);font-size:13px;margin:0 0 12px}
        .msg{font-size:14px;margin:4px 0;color:var(--ok)}
        .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:6px 0}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        input[type="text"],input[type="email"],textarea{width:100%;padding:10px;border:1px solid var(--bord);border-radius:10px;background:#f8fbff}
        textarea{min-height:90px;resize:vertical}
        .request-card{border:1px solid var(--bord);border-radius:12px;padding:12px;background:#fff;margin:10px 0}
        .flex{display:flex;gap:8px;align-items:center}
        .right{justify-content:flex-end}
        .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800;color:#fff;background:var(--btn)}
        .btn2{background:var(--btn2)} .btn-danger{background:var(--danger)}
        .section-title{display:flex;align-items:end;justify-content:space-between;gap:8px}
        .muted{color:#6b7280;font-size:13px}
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>개인정보 변경 요청 검토</h1>
        <p class="hint">카드 하나가 요청 1건입니다. 요청 값을 검토하고, 필요하면 수정 후 <b>승인</b>하거나 <b>반려 사유</b>를 적어 반려하세요.</p>
        <p class="msg" th:if="${msg}" th:text="${msg}"></p>
    </header>

    <!-- ========== 1) 주소지 변경 요청 목록 ========== -->
    <section class="card">
        <div class="section-title">
            <h2>주소지 변경 요청</h2>
            <span class="muted" th:text="|총 ${#lists.size(addressRequests)}건|">총 0건</span>
        </div>

        <div th:if="${#lists.isEmpty(addressRequests)}" class="hint">대기 중인 주소 변경 요청이 없습니다.</div>

        <!-- 요청 카드 반복 -->
        <article class="request-card" th:each="r : ${addressRequests}">
            <div class="grid-2">
                <div>
                    <div class="row"><strong>학생</strong><div th:text="${r.studentName}">홍길동</div></div>
                    <div class="row"><strong>이메일</strong><div th:text="${r.studentEmail}">student@school.ac.kr</div></div>
                    <div class="row"><strong>요청일</strong><div th:text="${#temporals.format(r.submittedAt, 'yyyy-MM-dd HH:mm')}">2025-09-01 10:30</div></div>
                </div>
                <div>
                    <div class="row"><strong>현재 주소</strong>
                        <div>
                            <div th:text="|(${r.currentPostalCode}) ${r.currentAddress1}|">(06018) 서울시 강남구 테헤란로 1</div>
                            <div class="muted" th:text="${r.currentAddress2}">OO아파트 101동 202호</div>
                        </div>
                    </div>
                </div>
            </div>

            <hr style="border:none;border-top:1px solid #eef2f7;margin:10px 0"/>

            <!-- 승인 폼: 매니저가 요청값을 필요 시 손보고 저장 -->
            <form th:action="@{/manager/profile/address-requests/{id}/approve(id=${r.id})}" method="post">
                <div class="row"><label for="pc__"  >새 우편번호</label>
                    <input id="pc__"   name="postalCode"  type="text" th:value="${r.reqPostalCode}" required/>
                </div>
                <div class="row"><label for="ad1__" >새 도로명</label>
                    <input id="ad1__"  name="address1"   type="text" th:value="${r.reqAddress1}" required/>
                </div>
                <div class="row"><label for="ad2__" >새 상세</label>
                    <input id="ad2__"  name="address2"   type="text" th:value="${r.reqAddress2}"/>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <div class="flex right" style="margin-top:8px">
                    <button type="submit" class="btn">승인(변경 적용)</button>
                </div>
            </form>

            <!-- 반려 폼: 사유 입력 후 반려 -->
            <form th:action="@{/manager/profile/address-requests/{id}/reject(id=${r.id})}" method="post" style="margin-top:8px">
                <div class="row">
                    <label for="rej__">반려 사유</label>
                    <textarea id="rej__" name="reason" placeholder="예: 주소 형식이 맞지 않습니다. 정확한 도로명 주소로 다시 제출해 주세요." required></textarea>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <div class="flex right">
                    <button type="submit" class="btn-danger">반려</button>
                </div>
            </form>
        </article>
    </section>

    <!-- ========== 2) 이메일 변경 요청 목록 ========== -->
    <section class="card">
        <div class="section-title">
            <h2>이메일 변경 요청</h2>
            <span class="muted" th:text="|총 ${#lists.size(emailRequests)}건|">총 0건</span>
        </div>

        <div th:if="${#lists.isEmpty(emailRequests)}" class="hint">대기 중인 이메일 변경 요청이 없습니다.</div>

        <article class="request-card" th:each="eReq : ${emailRequests}">
            <div class="grid-2">
                <div>
                    <div class="row"><strong>학생</strong><div th:text="${eReq.studentName}">김학생</div></div>
                    <div class="row"><strong>현재 이메일</strong><div th:text="${eReq.currentEmail}">old@school.ac.kr</div></div>
                    <div class="row"><strong>요청일</strong><div th:text="${#temporals.format(eReq.submittedAt,'yyyy-MM-dd HH:mm')}">2025-09-01 10:30</div></div>
                </div>
                <div class="row"><strong>변경 요청 이메일</strong>
                    <input name="newEmailPreview" type="email" th:value="${eReq.newEmail}" disabled/>
                </div>
            </div>

            <!-- 승인: 새 이메일을 확인/수정 가능하도록 입력칸 제공 -->
            <form th:action="@{/manager/profile/email-requests/{id}/approve(id=${eReq.id})}" method="post" style="margin-top:8px">
                <div class="row"><label>적용 이메일</label>
                    <input name="newEmail" type="email" th:value="${eReq.newEmail}" required/>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <div class="flex right">
                    <button class="btn" type="submit">승인(이메일 변경)</button>
                </div>
            </form>

            <!-- 반려 -->
            <form th:action="@{/manager/profile/email-requests/{id}/reject(id=${eReq.id})}" method="post" style="margin-top:8px">
                <div class="row"><label>반려 사유</label>
                    <textarea name="reason" placeholder="예: 학교 도메인만 허용됩니다." required></textarea>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

                <div class="flex right">
                    <button class="btn-danger" type="submit">반려</button>
                </div>
            </form>

            <p class="hint" style="margin-top:8px">
                ※ 비밀번호 변경 요청은 보안상 <b>평문 보관/표시 금지</b>입니다. 자체 처리 후 “재설정 메일 발송” 방식으로 운영하는 것을 권장합니다.
            </p>
        </article>
    </section>
</div>

</body>
</html>
